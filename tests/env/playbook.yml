---
- name: Automated tests against real bamboo server
  hosts: bamboo-agent
  vars:
    bamboo_server: "http://bamboo-server:8085"
    bamboo_home: "/home/bamboo/bamboo-agent-home"
    bamboo_user: "admin"
    bamboo_password: "admin"
  tasks:
  - name: Register bamboo agent
    stefanhoelzl.bamboo_agent.configuration:
      host: "{{ bamboo_server }}"
      home: "{{ bamboo_home }}"
      credentials:
        user: "{{ bamboo_user }}"
        password: "{{ bamboo_password }}"
      timings:
        http_timeout: 60
  - name: Query registered agents
    uri:
      url: "http://bamboo-server:8085/rest/api/latest/agent/"
      method: GET
      force_basic_auth: yes
      user: "admin"
      password: "admin"
      status_code: 200
      dest: "/results/registration.json"
  - name: Disable agent
    stefanhoelzl.bamboo_agent.configuration:
      host: "{{ bamboo_server }}"
      home: "{{ bamboo_home }}"
      enabled: false
      credentials:
        user: "{{ bamboo_user }}"
        password: "{{ bamboo_password }}"
  - name: Query agent disabled
    uri:
      url: "http://bamboo-server:8085/rest/api/latest/agent/"
      method: GET
      force_basic_auth: yes
      user: "admin"
      password: "admin"
      status_code: 200
      dest: "/results/disabled.json"
  - name: Set bamboo agent name
    stefanhoelzl.bamboo_agent.configuration:
      host: "{{ bamboo_server }}"
      home: "{{ bamboo_home }}"
      name: "new-name"
      credentials:
        user: "{{ bamboo_user }}"
        password: "{{ bamboo_password }}"
  - name: Query changed name
    uri:
      url: "http://bamboo-server:8085/rest/api/latest/agent/"
      method: GET
      force_basic_auth: yes
      user: "admin"
      password: "admin"
      status_code: 200
      dest: "/results/changed_name.json"
  - name: Assignments
    stefanhoelzl.bamboo_agent.configuration:
      host: "{{ bamboo_server }}"
      home: "{{ bamboo_home }}"
      assignments:
      - type: project
        key: DP
      credentials:
        user: "{{ bamboo_user }}"
        password: "{{ bamboo_password }}"
    register: current_state
  - name: save current state
    copy:
      content: "{{ current_state | to_json }}"
      dest: "/results/current_state.json"
  - name: No changes
    stefanhoelzl.bamboo_agent.configuration:
      host: "{{ bamboo_server }}"
      home: "{{ bamboo_home }}"
      name: "new-name"
      enabled: false
      assignments:
      - type: project
        key: DP
      credentials:
        user: "{{ bamboo_user }}"
        password: "{{ bamboo_password }}"
  - name: Query no changes
    uri:
      url: "http://bamboo-server:8085/rest/api/latest/agent/"
      method: GET
      force_basic_auth: yes
      user: "admin"
      password: "admin"
      status_code: 200
      dest: "/results/unchanged.json"